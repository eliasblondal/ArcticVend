{% extends "admin/base.html" %}

{% block title %}Shelf Management - Kiosk Admin{% endblock %}
{% block page_title %}Shelf Management{% endblock %}

{% block content %}
<div class="shelf-management">
    <!-- Zone Configuration (Individual Shelf) -->
    <div class="card mb-4" id="zone-config-card" style="display: none;">
        <div class="card-header bg-warning">
            <h5><i class="fas fa-cog me-2"></i>Configure Shelf Sizes</h5>
        </div>
        <div class="card-body">
            <div class="alert alert-warning">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <strong>Warning:</strong> Click on S/M/L buttons for each shelf to set its size. This affects product compatibility.
            </div>
            
            <div class="shelf-config-grid">
                {% for shelf in range(1, 41) %}
                <div class="config-shelf-item" data-shelf="{{ shelf }}">
                    <div class="shelf-label">{{ shelf }}</div>
                    <div class="size-buttons">
                        <button class="size-btn btn-sm" data-size="small" onclick="setShelfSize({{ shelf }}, 'small')">S</button>
                        <button class="size-btn btn-sm" data-size="medium" onclick="setShelfSize({{ shelf }}, 'medium')">M</button>
                        <button class="size-btn btn-sm" data-size="large" onclick="setShelfSize({{ shelf }}, 'large')">L</button>
                    </div>
                </div>
                {% endfor %}
            </div>
            
            <div class="mt-3">
                <button class="btn btn-danger" onclick="saveShelfConfig()">
                    <i class="fas fa-save me-2"></i>Save Configuration
                </button>
                <button class="btn btn-secondary" onclick="cancelShelfConfig()">
                    <i class="fas fa-times me-2"></i>Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- Product Selector and Controls -->
    <div class="card mb-4">
        <div class="card-header">
            <div class="d-flex justify-content-between align-items-center">
                <h5><i class="fas fa-box me-2"></i>Product Assignment</h5>
                <div>
                    <button class="btn btn-warning btn-sm me-2" onclick="openShelfConfig()">
                        <i class="fas fa-cog me-1"></i>Configure Shelf Sizes
                    </button>
                    <button class="btn btn-primary btn-sm" onclick="syncProducts()">
                        <i class="fas fa-sync me-1"></i>Sync Products
                    </button>
                </div>
            </div>
        </div>
        <div class="card-body">
            <div class="row g-3 align-items-end">
                <div class="col-md-5">
                    <label for="product-selector" class="form-label">Select Product from Shopify</label>
                    <select id="product-selector" class="form-select form-select-lg">
                        <option value="">-- Select a product to assign --</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label for="quantity-input" class="form-label">Quantity</label>
                    <input type="number" id="quantity-input" class="form-control" min="1" disabled>
                </div>
                <div class="col-md-2">
                    <div id="product-info" class="text-muted" style="display: none;">
                        <small>Size: <span id="box-size-display" class="badge bg-info"></span></small><br>
                        <small>Available: <span id="available-display"></span></small>
                    </div>
                </div>
                <div class="col-md-3">
                    <button class="btn btn-success w-100" id="assign-btn" disabled onclick="assignToShelf()">
                        <i class="fas fa-plus me-2"></i>Assign to Selected Shelf
                    </button>
                </div>
            </div>
            
            <div id="partial-assignment-reason" class="mt-2" style="display: none;">
                <label class="form-label text-warning">Why are you not assigning all available units?</label>
                <input type="text" id="reason-input" class="form-control" placeholder="e.g., Distributing across multiple shelves">
            </div>
        </div>
    </div>
    
    <!-- Visual Shelf Grid -->
    <div class="card">
        <div class="card-header">
            <div class="d-flex justify-content-between align-items-center">
                <h5><i class="fas fa-warehouse me-2"></i>Shelf Layout (40 Shelves)</h5>
                <div class="shelf-legend">
                    <span class="legend-item"><span class="legend-color compatible"></span> Compatible</span>
                    <span class="legend-item"><span class="legend-color occupied"></span> Occupied</span>
                    <span class="legend-item"><span class="legend-color empty"></span> Empty</span>
                    <span class="legend-item"><span class="legend-color incompatible"></span> Incompatible</span>
                </div>
            </div>
        </div>
        <div class="card-body">
            <div class="shelf-grid-wrapper">
                <div class="shelf-grid">
                    {% for shelf in range(1, 41) %}
                    <div class="shelf-item" data-shelf="{{ shelf }}" onclick="selectShelf({{ shelf }})">
                        <div class="shelf-number">{{ shelf }}</div>
                        <div class="shelf-indicator"></div>
                        <div class="shelf-size-badge"></div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Shelf Details Modal -->
<div class="modal fade" id="shelfDetailsModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Shelf Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="shelf-details-content">
                <!-- Populated dynamically -->
            </div>
        </div>
    </div>
</div>

<!-- Confirmation Modal -->
<div class="modal fade" id="confirmModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning">
                <h5 class="modal-title"><i class="fas fa-exclamation-triangle me-2"></i>Confirm Configuration</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to save the shelf size configuration?</p>
                <p class="text-danger"><strong>Warning:</strong> This will affect product compatibility for all shelves.</p>
                <div id="config-changes" class="mt-3"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="confirmShelfChanges()">
                    <i class="fas fa-check me-2"></i>Confirm Changes
                </button>
            </div>
        </div>
    </div>
</div>

<style>
.shelf-management {
    padding: 20px;
}

.shelf-grid-wrapper {
    background: #f8f9fa;
    padding: 20px;
    border-radius: 8px;
}

.shelf-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
    gap: 12px;
    max-width: 1200px;
    margin: 0 auto;
}

@media (min-width: 768px) {
    .shelf-grid {
        grid-template-columns: repeat(8, 1fr);
    }
}

@media (min-width: 1200px) {
    .shelf-grid {
        grid-template-columns: repeat(10, 1fr);
    }
}

.shelf-item {
    background: white;
    border: 2px solid #dee2e6;
    border-radius: 8px;
    padding: 8px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
    min-height: 80px;
    position: relative;
}

.shelf-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.shelf-item.selected {
    border-color: #0d6efd;
    background: #e7f1ff;
    box-shadow: 0 0 0 3px rgba(13, 110, 253, 0.25);
}

.shelf-item.compatible {
    border-color: #28a745;
    background: #d4edda;
}

.shelf-item.incompatible {
    border-color: #dc3545;
    background: #f8d7da;
    cursor: not-allowed;
    opacity: 0.6;
}

.shelf-item.occupied {
    border-color: #ffc107;
}

.shelf-item.same-product {
    border-color: #17a2b8;
    background: #d1ecf1;
}

.shelf-number {
    font-weight: bold;
    font-size: 1rem;
    color: #495057;
}

.shelf-indicator {
    width: 30px;
    height: 30px;
    margin: 5px auto;
    border-radius: 50%;
    background: #e9ecef;
}

.shelf-item.occupied .shelf-indicator {
    background: #ffc107;
}

.shelf-size-badge {
    position: absolute;
    top: 2px;
    right: 2px;
    font-size: 0.6rem;
    font-weight: bold;
    padding: 2px 4px;
    border-radius: 3px;
}

.shelf-size-badge.size-small {
    background: #6c757d;
    color: white;
}

.shelf-size-badge.size-medium {
    background: #0d6efd;
    color: white;
}

.shelf-size-badge.size-large {
    background: #ffc107;
    color: black;
}

/* Configuration Grid */
.shelf-config-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
    gap: 10px;
    max-height: 400px;
    overflow-y: auto;
    padding: 10px;
    background: #f8f9fa;
    border-radius: 5px;
}

.config-shelf-item {
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 5px;
    padding: 8px;
    text-align: center;
}

.shelf-label {
    font-weight: bold;
    margin-bottom: 5px;
}

.size-buttons {
    display: flex;
    gap: 2px;
    justify-content: center;
}

.size-btn {
    padding: 2px 8px;
    border: 1px solid #dee2e6;
    background: white;
    cursor: pointer;
    border-radius: 3px;
    font-size: 0.75rem;
}

.size-btn:hover {
    background: #e9ecef;
}

.size-btn.active-small {
    background: #6c757d;
    color: white;
}

.size-btn.active-medium {
    background: #0d6efd;
    color: white;
}

.size-btn.active-large {
    background: #ffc107;
    color: black;
}

.shelf-legend {
    display: flex;
    gap: 15px;
    flex-wrap: wrap;
}

.legend-item {
    display: flex;
    align-items: center;
    gap: 5px;
    font-size: 0.9rem;
}

.legend-color {
    width: 18px;
    height: 18px;
    border-radius: 4px;
    border: 1px solid #dee2e6;
}

.legend-color.compatible {
    background: #d4edda;
    border-color: #28a745;
}

.legend-color.occupied {
    background: #ffc107;
}

.legend-color.empty {
    background: #e9ecef;
}

.legend-color.incompatible {
    background: #f8d7da;
    border-color: #dc3545;
}
</style>

<script>
let products = [];
let shelves = [];
let selectedProduct = null;
let selectedShelf = null;
let productMetadata = {};
let shelfSizes = {};
let tempShelfConfig = {};

// Load data on page load
document.addEventListener('DOMContentLoaded', function() {
    loadShelfData();
});

function loadShelfData() {
    fetch('/admin/shelves/assign')
        .then(response => response.json())
        .then(data => {
            products = data.products;
            shelves = data.shelves;
            productMetadata = data.metadata;
            shelfSizes = data.shelf_sizes || {};
            
            // Load shelf configurations
            fetch('/admin/shelves/zones')
                .then(res => res.json())
                .then(zoneData => {
                    if (zoneData.shelves) {
                        shelfSizes = zoneData.shelves;
                    }
                    populateProductSelector();
                    updateShelfDisplay();
                });
        })
        .catch(error => {
            console.error('Error loading shelf data:', error);
        });
}

function populateProductSelector() {
    const selector = document.getElementById('product-selector');
    selector.innerHTML = '<option value="">-- Select a product to assign --</option>';
    
    products.forEach(product => {
        const option = document.createElement('option');
        option.value = product.sku;
        option.textContent = `${product.title} (SKU: ${product.sku}) - ${product.available_to_assign || product.available} available to assign`;
        option.dataset.product = JSON.stringify(product);
        selector.appendChild(option);
    });
    
    selector.addEventListener('change', onProductSelected);
}

function onProductSelected() {
    const selector = document.getElementById('product-selector');
    const selected = selector.value;
    
    if (!selected) {
        selectedProduct = null;
        document.getElementById('product-info').style.display = 'none';
        document.getElementById('quantity-input').disabled = true;
        clearShelfHighlights();
        return;
    }
    
    const option = selector.querySelector(`option[value="${selected}"]`);
    selectedProduct = JSON.parse(option.dataset.product);
    
    // Show product info
    const productInfo = document.getElementById('product-info');
    productInfo.style.display = 'block';
    
    const metadata = productMetadata[selectedProduct.sku] || { box_size: 'medium', max_stack: 10 };
    document.getElementById('box-size-display').textContent = metadata.box_size;
    document.getElementById('available-display').textContent = selectedProduct.available_to_assign || selectedProduct.available;
    
    // Enable quantity input
    const quantityInput = document.getElementById('quantity-input');
    quantityInput.disabled = false;
    quantityInput.max = selectedProduct.available_to_assign || selectedProduct.available;
    quantityInput.value = selectedProduct.available_to_assign || selectedProduct.available;
    
    // Watch for quantity changes
    quantityInput.addEventListener('input', onQuantityChange);
    
    // Highlight compatible shelves
    highlightCompatibleShelves(metadata.box_size);
}

function onQuantityChange() {
    const quantity = parseInt(document.getElementById('quantity-input').value);
    const available = selectedProduct.available_to_assign || selectedProduct.available;
    
    const reasonDiv = document.getElementById('partial-assignment-reason');
    if (quantity < available) {
        reasonDiv.style.display = 'block';
    } else {
        reasonDiv.style.display = 'none';
    }
}

function highlightCompatibleShelves(boxSize) {
    clearShelfHighlights();
    
    const shelfItems = document.querySelectorAll('.shelf-item');
    shelfItems.forEach(item => {
        const shelfNumber = parseInt(item.dataset.shelf);
        const shelfSize = shelfSizes[shelfNumber] || getDefaultSize(shelfNumber);
        const isCompatible = shelfSize === boxSize;
        const currentShelf = shelves.find(s => s.shelf_number === shelfNumber);
        
        if (currentShelf && currentShelf.sku === selectedProduct.sku) {
            item.classList.add('same-product');
        } else if (currentShelf && currentShelf.sku) {
            item.classList.add('occupied');
        } else if (isCompatible) {
            item.classList.add('compatible');
        } else {
            item.classList.add('incompatible');
        }
    });
}

function getDefaultSize(shelfNumber) {
    if (shelfNumber <= 15) return 'small';
    if (shelfNumber <= 30) return 'medium';
    return 'large';
}

function clearShelfHighlights() {
    const shelfItems = document.querySelectorAll('.shelf-item');
    shelfItems.forEach(item => {
        item.classList.remove('compatible', 'incompatible', 'occupied', 'same-product', 'selected');
    });
}

function selectShelf(shelfNumber) {
    const item = document.querySelector(`[data-shelf="${shelfNumber}"]`);
    const currentShelf = shelves.find(s => s.shelf_number === shelfNumber);
    
    // If shelf has product, show details
    if (currentShelf && currentShelf.sku && !selectedProduct) {
        showShelfDetails(shelfNumber, currentShelf);
        return;
    }
    
    if (!selectedProduct) {
        alert('Please select a product first');
        return;
    }
    
    if (item.classList.contains('incompatible')) {
        alert('This shelf is not compatible with the selected product size');
        return;
    }
    
    // Clear previous selection
    document.querySelectorAll('.shelf-item').forEach(b => b.classList.remove('selected'));
    
    // Select this shelf
    item.classList.add('selected');
    selectedShelf = shelfNumber;
    
    // Enable assign button
    document.getElementById('assign-btn').disabled = false;
}

function showShelfDetails(shelfNumber, shelf) {
    const content = `
        <p><strong>Shelf Number:</strong> ${shelfNumber}</p>
        <p><strong>Product:</strong> ${shelf.product_name}</p>
        <p><strong>SKU:</strong> ${shelf.sku}</p>
        <p><strong>Assigned Quantity:</strong> ${shelf.assigned_quantity || 0}</p>
        <p><strong>Current Stock:</strong> ${shelf.current_stock}</p>
        <p><strong>Size Category:</strong> ${shelfSizes[shelfNumber] || getDefaultSize(shelfNumber)}</p>
    `;
    
    document.getElementById('shelf-details-content').innerHTML = content;
    const modal = new bootstrap.Modal(document.getElementById('shelfDetailsModal'));
    modal.show();
}

function assignToShelf() {
    if (!selectedProduct || !selectedShelf) {
        alert('Please select both a product and a shelf');
        return;
    }
    
    const quantity = parseInt(document.getElementById('quantity-input').value);
    const reason = document.getElementById('reason-input').value;
    
    if (quantity < (selectedProduct.available_to_assign || selectedProduct.available) && !reason) {
        alert('Please provide a reason for partial assignment');
        return;
    }
    
    const data = {
        shelf_number: selectedShelf,
        sku: selectedProduct.sku,
        product_name: selectedProduct.title,
        quantity: quantity,
        reason: reason
    };
    
    fetch('/admin/shelves/assign', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            loadShelfData();
            
            // Reset selection
            document.getElementById('product-selector').value = '';
            document.getElementById('quantity-input').value = '';
            document.getElementById('reason-input').value = '';
            document.getElementById('partial-assignment-reason').style.display = 'none';
            selectedProduct = null;
            selectedShelf = null;
            document.getElementById('assign-btn').disabled = true;
            clearShelfHighlights();
        } else {
            alert('Error: ' + (data.error || 'Failed to assign shelf'));
        }
    })
    .catch(error => {
        console.error('Error assigning shelf:', error);
        alert('Failed to assign shelf');
    });
}

function updateShelfDisplay() {
    // Update shelf indicators
    document.querySelectorAll('.shelf-item').forEach(item => {
        const shelfNum = parseInt(item.dataset.shelf);
        const shelf = shelves.find(s => s.shelf_number === shelfNum);
        const size = shelfSizes[shelfNum] || getDefaultSize(shelfNum);
        
        // Add size badge
        const sizeBadge = item.querySelector('.shelf-size-badge');
        if (size === 'small') {
            sizeBadge.className = 'shelf-size-badge size-small';
            sizeBadge.textContent = 'S';
        } else if (size === 'medium') {
            sizeBadge.className = 'shelf-size-badge size-medium';
            sizeBadge.textContent = 'M';
        } else {
            sizeBadge.className = 'shelf-size-badge size-large';
            sizeBadge.textContent = 'L';
        }
        
        // Mark occupied shelves
        if (shelf && shelf.sku) {
            item.classList.add('occupied');
        }
    });
}

function openShelfConfig() {
    document.getElementById('zone-config-card').style.display = 'block';
    tempShelfConfig = {...shelfSizes};
    
    // Set current configuration
    document.querySelectorAll('.config-shelf-item').forEach(item => {
        const shelfNum = parseInt(item.dataset.shelf);
        const size = shelfSizes[shelfNum] || getDefaultSize(shelfNum);
        
        item.querySelectorAll('.size-btn').forEach(btn => {
            btn.classList.remove('active-small', 'active-medium', 'active-large');
            if (btn.dataset.size === size) {
                btn.classList.add(`active-${size}`);
            }
        });
    });
}

function setShelfSize(shelfNumber, size) {
    tempShelfConfig[shelfNumber] = size;
    
    // Update button states
    const item = document.querySelector(`.config-shelf-item[data-shelf="${shelfNumber}"]`);
    item.querySelectorAll('.size-btn').forEach(btn => {
        btn.classList.remove('active-small', 'active-medium', 'active-large');
        if (btn.dataset.size === size) {
            btn.classList.add(`active-${size}`);
        }
    });
}

function cancelShelfConfig() {
    document.getElementById('zone-config-card').style.display = 'none';
    tempShelfConfig = {};
}

function saveShelfConfig() {
    // Show confirmation modal
    const changesDiv = document.getElementById('config-changes');
    let changesHtml = '<p>The following shelves will be updated:</p><ul>';
    
    for (const [shelf, size] of Object.entries(tempShelfConfig)) {
        const currentSize = shelfSizes[shelf] || getDefaultSize(parseInt(shelf));
        if (currentSize !== size) {
            changesHtml += `<li>Shelf ${shelf}: ${currentSize} â†’ ${size}</li>`;
        }
    }
    changesHtml += '</ul>';
    
    changesDiv.innerHTML = changesHtml;
    
    const modal = new bootstrap.Modal(document.getElementById('confirmModal'));
    modal.show();
}

function confirmShelfChanges() {
    fetch('/admin/shelves/zones', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ shelves: tempShelfConfig })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            shelfSizes = tempShelfConfig;
            updateShelfDisplay();
            alert('Shelf configuration updated successfully');
            
            // Hide modal and config card
            bootstrap.Modal.getInstance(document.getElementById('confirmModal')).hide();
            document.getElementById('zone-config-card').style.display = 'none';
            
            // Reload shelf data
            loadShelfData();
        } else {
            alert('Error: ' + (data.error || 'Failed to update configuration'));
        }
    })
    .catch(error => {
        console.error('Error updating configuration:', error);
        alert('Failed to update shelf configuration');
    });
}

function syncProducts() {
    const btn = event.target;
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Syncing...';
    
    fetch('/admin/products/sync', {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            alert(data.message);
            loadShelfData();
        } else {
            alert('Error: ' + (data.error || 'Failed to sync products'));
        }
    })
    .catch(error => {
        console.error('Error syncing products:', error);
        alert('Failed to sync products');
    })
    .finally(() => {
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-sync me-1"></i>Sync Products';
    });
}
</script>
{% endblock %}